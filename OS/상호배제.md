# 상호배제, Mutual Exclusion

: 여러 프로세스가 동시에 공유 자원을 사용하려 할 때 다른 프로세스가 해당 공유 자원을 사용하지 못하게 제어하며 각 프로세스가 번갈아서 공유 자원을 사용하도록 하는 것, 임계 구역을 유지하는 기법

- 동기화로 상호배제 보장할 수 있지만, 이 과정에서 교착 상태와 기아 상태가 발생할 수 있음

## 1. 상호배제 조건

- 두 프로세스는 동시에 공유 자원에 진입 불가
- 프로세스의 속도나 프로세서 수에 영향 받지 않음
- 공유 자원을 사용하는 프로세스만 다른 프로세스 차단 가능
- 프로세스가 공유 자원을 사용하려고 너무 오래 기다려서는 안 됨

<br />

## 2. 상호배제 방법

### 1) 소프트웨어적인 방법

#### 피터슨 알고리즘

- 2개의 프로세스만 사용 가능

  ```
  //프로세스 P1
  lock1 = true;
  turn = 2;
  while(lock2==true && turn==2);
  /**임계구역**/
  lock1 = false;
  ```

  ```
  //프로세스 P2
  lock2 = true;
  turn = 1;
  while(lock1==true && turn==1);
  /**임계구역**/
  lock2 = false;
  ```

  

#### 데커 알고리즘

- 각 프로세스 플래그 설정 가능, 다른 프로세스 확인 후 플래그 재설정 가능
- 프로세스가 임예 영역에 진입하고 싶으면 플래그 설정하고 대기

![](D:/Hajung/git/SW_Studying/img/프로세스동기화_3.png)

![](D:/Hajung/git/SW_Studying/img/프로세스동기화_4.png)

- 임계영역 바깥에서 수행 중인 프로세스가 다른 프로세스들이 임계 영역 진입 막지 않음
- 임계 영역에 들어가기를 원하는 프로세서 무한정 기다리게 하지 않음 
- 그 외 알고리즘
  - 크누스 알고리즘, 다익스트라 알고리즘, 램포트의 베이커리(빵집) 알고리즘

### 2) 하드웨어적인 방법

#### TestAndSet(테스) 명령어

- 공유 변수를 수정하는 동안 인터럽트의 발생을 억제하여 임계 영역 문제 간단 해결
- 메모리 영역의 값에 대해 검사와 수정을 원자적으로 수행할 수 있는 하드웨어 명령어 
- 알고리즘이 간단, 하나의 메모리 사이클에서 수행하여 경쟁 상황 해결
- 바쁜 대기가 발생하고, 기아 상태, 교착 상태 발생 가능

```
boolean TestAndSet (boolean *target){
	boolean temp = *target; //이전 값 기록
	*target = true; 		//true로 설정
	return temp;			//값 반환
}

//lock을 사용한 상호배제
do
{
	while (TestAndSet(&lock))	//lock을 검사하여 true이면 대기, false이면 임계 영역 진입
		;
		//임계영역
	lock = false;				//다른 프로세스의 진입 허용 의미로 lock을 false로 
	//나머지 영역
}while(true);

//TestAndSet명령어를 이용한 상호배제
do
{
	waiting[i] = true;
}

```

### 소프트웨어적인 방법과 하드웨어적인 방법 모두 바쁜 대기(Busy wating)문제를 발생시킨다.

- 바쁜대기: 현재 임계구역내에 이미 프로세스가 들어가 있음에도 불구하고 정해진 타임동안 루프를 돌며 임계구역으로 진입을 시도하는 경우, CPU를 낭비하는 결과를 초래한다.

### 3) 프로그래밍 언어와 운영체제 수준에서의 방법

#### 세마포어, Semapores

: 공유된 자원의 데이터에 여러 프로세스가 접근하는 것을 막는 것

- 임계구역에 진입하기 전에 스위치를 사용 중으로 놓고 임계구역으로 들어감
- 이후에 도착하는 프로세스는 앞의 프로세스가 작업을 마칠 때까지 기다림
- 프로세스가 작업을 마치면 다음 프로세스에 임계구역을 사용하라는 동기화 신호를 보냄

```
Semaphore(n);	//RS=n;
P();			//if RS>0 then RS=RS-1; else block();
/**임계구역**/	
V();			//RS=RS+1; wake_up();
```

- Semaphore(n): 전역변수 RS를 n으로 초기화, RS에는 현재 사용가능한 자원의 수가 저장
- P(): 잠금을 수행하는 코드로 RS가 0보다 크면(사용 가능한 자원이 있으면) 1만큼 감소시키고 임계구역에 진입, 만약 RS가 0보다 작으면(사용 가능한 자원이 없으면) 0보다 커질 때까지 기다림
- V(): 잠금 해제와 동기화를 같이 수행하는 코드로, RS값을 1증가시키고 세마포어에서 기다리는 프로세스에게 임계구역에 진입해도 좋다는 wake_up신호를 보냄

#### 뮤텍스, Mutex

: 공유된 자원의 데이터를 여러 스레드가 접근하는 것을 막는 것

- 이진 세마포어로 사용할 수 있다.
- vs 세마포어
  - 세마포어는 뮤텍스가 될 수 있지만, 뮤텍스는 세마포어가 될 수 없다.
  - 세마포어는 파일시스템 상 파일형태로 존자, 뮤텍스는 프로세스 범위